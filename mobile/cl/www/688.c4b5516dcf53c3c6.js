"use strict";(self.webpackChunkcnl=self.webpackChunkcnl||[]).push([[688],{1688:(N,c,r)=>{r.r(c),r.d(c,{DebitNoteComponent:()=>D});var l=r(6814),d=r(3929),e=r(5879),u=r(7871),p=r(2787);let m=(()=>{class s{refreshTable(){this.taTableComponent?.refresh()}constructor(t){this.router=t,this.edit=new e.vpe,this.circle=new e.vpe,this.tableConfig={apiUrl:"sales/sale_debit_notes/",showCheckbox:!0,pkId:"debit_note_id",pageSize:10,globalSearch:{keys:["customer","debit_date","sale_invoice_id","debit_note_number","reason","total_amount","status_name"]},defaultSort:{key:"created_at",value:"descend"},cols:[{fieldKey:"customer",name:"Customer",displayType:"map",mapFn:(o,i,n)=>`${i.customer.name}`,sort:!0},{fieldKey:"sale_invoice_id",name:"Invoice",displayType:"map",mapFn:(o,i,n)=>`${i.sale_invoice.invoice_no}`,sort:!0},{fieldKey:"debit_note_number",name:"Debit note no",sort:!0},{fieldKey:"debit_date",name:"Debit Date",sort:!0},{fieldKey:"reason",name:"Return Reason",sort:!0},{fieldKey:"total_amount",name:"Total Amount",sort:!0},{fieldKey:"status_name",name:"Status",displayType:"map",mapFn:(o,i,n)=>`${i.order_status.status_name}`,sort:!0},{fieldKey:"code",name:"Action",type:"action",actions:[{type:"delete",label:"Delete",confirm:!0,confirmMsg:"Sure to delete?",apiUrl:"sales/sale_debit_notes"},{type:"callBackFn",icon:"fa fa-pen",label:"",callBackFn:(o,i)=>{console.log(o),this.edit.emit(o.debit_note_id)}},{type:"callBackFn",icon:"fa fa-check-circle",confirm:!0,confirmMsg:"Sure to Approve?",callBackFn:(o,i)=>{console.log(o),this.circle.emit(o.debit_note_id)}}]}]}}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(p.F0))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-debit-note-list"]],viewQuery:function(t,o){if(1&t&&e.Gf(u.Z,5),2&t){let i;e.iGM(i=e.CRH())&&(o.taTableComponent=i.first)}},outputs:{edit:"edit",circle:"circle"},standalone:!0,features:[e.jDz],decls:1,vars:1,consts:[[3,"options"]],template:function(t,o){1&t&&e._UZ(0,"ta-table",0),2&t&&e.Q6J("options",o.tableConfig)},dependencies:[l.ez,d.l,u.Z]}),s})();var b=r(9862),_=r(7127);const f=["salesdebitnoteForm"];function g(s,a){1&s&&(e.TgZ(0,"span",23),e._uU(1,"Update Debit Note"),e.qZA())}function h(s,a){1&s&&(e.TgZ(0,"span",23),e._uU(1,"Create Debit Note"),e.qZA())}function y(s,a){if(1&s&&(e.TgZ(0,"div",24),e._UZ(1,"ta-form",25,26),e.qZA()),2&s){const t=e.oxw();e.xp6(1),e.Q6J("options",t.formConfig)}}function C(s,a){if(1&s){const t=e.EpF();e.TgZ(0,"div",27)(1,"app-debit-note-list",28),e.NdJ("edit",function(i){e.CHM(t);const n=e.oxw();return e.KtG(n.editSaleDebitnote(i))})("circle",function(i){e.CHM(t);const n=e.oxw();return e.KtG(n.circleSaleDebitnote(i))}),e.qZA()()}}function x(s,a){if(1&s&&(e.TgZ(0,"div",29)(1,"span",30),e._uU(2,"\u2714"),e.qZA(),e._uU(3),e.qZA()),2&s){const t=e.oxw();e.xp6(3),e.hij(" ",t.sidebarMessage," ")}}function v(s,a){if(1&s&&(e.TgZ(0,"div",31)(1,"div",32)(2,"span",33),e._uU(3,"\u2714"),e.qZA()(),e.TgZ(4,"span",34),e._uU(5),e.qZA()()),2&s){const t=e.oxw();e.xp6(5),e.Oqu(t.toastMessage)}}let D=(()=>{class s{constructor(t,o){this.http=t,this.cdr=o,this.sidebarMessage="",this.showSaleDebitnoteList=!1,this.showForm=!1,this.customerOrders=[],this.invoiceOptions=[],this.nowDate=()=>{const i=new Date;return`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()}`},this.formConfig={},this.toastMessage="",this.showSuccessToast=!1}ngOnInit(){this.showSaleDebitnoteList=!1,this.showForm=!0,this.SaleDebitnoteEditID=null,this.setFormConfig(),this.getOrderNo(),this.formConfig.fields[0].fieldGroup[5].hide=!0;const t=localStorage.getItem("sidebarMessage");t&&(this.sidebarMessage=t,localStorage.removeItem("sidebarMessage"),setTimeout(()=>{this.sidebarMessage=""},3e3))}hide(){document.getElementById("modalClose").click()}updateSaleDebitNote(){const t=this.formConfig.model.sale_debit_note.debit_note_id;console.log("Sale return id in edit : ",t),this.http.put(`sales/sale_debit_notes/${t}/`,{sale_debit_note:this.formConfig.model.sale_debit_note,sale_debit_note_items:this.formConfig.model.sale_debit_note_items}).subscribe(i=>{this.showSuccessToast=!0,this.toastMessage="Record Updated successfully",this.ngOnInit(),setTimeout(()=>{this.showSuccessToast=!1},3e3)},i=>{console.error("Error updating Sale Debit Note:",i)})}editSaleDebitnote(t){this.SaleDebitnoteEditID=t,this.http.get("sales/sale_debit_notes/"+t).subscribe(o=>{o&&o.data&&(this.formConfig.model=o.data,this.formConfig.pkId="debit_note_id",this.formConfig.submit.label="Update",this.formConfig.model.debit_note_id=this.SaleDebitnoteEditID,this.formConfig.fields[0].fieldGroup[5].hide=!1,this.showForm=!0)}),this.hide()}onSubmit(){"Update"===this.formConfig.submit.label?this.updateSaleDebitNote():this.handleSubmission()}circleSaleDebitnote(t){this.SaleDebitnoteEditID=t,this.http.patch("sales/sale_debit_notes/"+t+"/",{order_status_id:"68ea000e-ce95-4145-a3c7-96efe6f9ff53"}).subscribe(o=>{o&&o.debit_note_id?(localStorage.setItem("sidebarMessage","Order status Approved"),window.location.reload()):console.error("Error updating order status:",o)},o=>{console.error("HTTP error:",o)})}getOrderNo(){this.orderNumber=null,this.http.get("masters/generate_order_no/?type=DN").subscribe(t=>{console.log("RES data in orderno : ",t.data.order_number),t.data&&t.data.order_number&&(this.orderNumber=t.data.order_number,this.formConfig.model.sale_debit_note.debit_note_number=this.orderNumber)})}showSaleDebitNoteListFn(){this.showSaleDebitnoteList=!0,this.DebitNoteListComponent?.refreshTable()}setFormConfig(){this.SaleDebitnoteEditID=null,this.formConfig={title:"",formState:{viewMode:!1},showActionBtn:!0,exParams:[{key:"sale_debit_note_items",type:"script",value:"data.sale_debit_note_items.map(m=> {m.product_id = m.product.product_id;  return m ;})"}],submit:{label:"Submit",submittedFn:()=>this.onSubmit()},reset:{resetFn:()=>{this.ngOnInit()}},model:{sale_debit_note:{},sale_debit_note_items:[{}]},fields:[{fieldGroupClassName:"ant-row custom-form-block px-0 mx-0",key:"sale_debit_note",fieldGroup:[{key:"customer",type:"select",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Select Customer",placeholder:"Select Customer",dataKey:"name",dataLabel:"name",required:!0,lazy:{url:"customers/customers/?summary=true",lazyOneTime:!0}},hooks:{onChanges:t=>{t.formControl.valueChanges.subscribe(o=>{console.log("Data in customer : ",o),o&&o.customer_id&&(this.formConfig.model.sale_debit_note.customer_id=o.customer_id,console.log("Datacustomer : ",o.customer_id),this.loadSaleInvoices(o.customer_id))})}}},{key:"sale_invoice_id",type:"select",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Sale Invoice",placeholder:"Select Sale Invoice",dataKey:"sale_invoice_id",dataLabel:"invoice_no",required:!0,options:[]}},{key:"debit_note_number",type:"input",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Credit note no",placeholder:"Enter Credit note no",required:!0,readonly:!0}},{key:"debit_date",type:"date",defaultValue:this.nowDate(),className:"col-md-4 col-sm-6 col-12",templateOptions:{type:"date",label:"Debit date",readonly:!0,required:!0}},{key:"total_amount",type:"input",className:"col-md-4 col-sm-6 col-12",templateOptions:{type:"number",label:"Total amount",placeholder:"Enter Total amount"}},{key:"order_status",type:"select",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Order status",dataKey:"order_status_id",dataLabel:"status_name",placeholder:"Select Order status type",lazy:{url:"masters/order_status/",lazyOneTime:!0}},hooks:{onChanges:t=>{t.formControl.valueChanges.subscribe(o=>{o&&o.order_status_id&&(this.formConfig.model.sale_debit_note.order_status_id=o.order_status_id)})}}},{key:"reason",type:"textarea",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Reason",placeholder:"Enter Reason"}}]},{key:"sale_debit_note_items",type:"table",className:"custom-form-list",templateOptions:{title:"Products",addText:"Add Product",tableCols:[{name:"product",label:"Product"},{name:"quantity",label:"Quantity"},{name:"total_price",label:"Price"},{name:"price_per_unit",label:"Rate"}]},fieldArray:{fieldGroup:[{key:"product",type:"select",templateOptions:{label:"Select Product",dataKey:"product_id",hideLabel:!0,dataLabel:"name",options:[],required:!0,lazy:{url:"products/products/?summary=true",lazyOneTime:!0}},hooks:{onInit:t=>{t.formControl.valueChanges.subscribe(o=>{this.productOptions=o,t.form&&t.form.controls&&t.form.controls.price_per_unit&&o&&o.mrp&&t.form.controls.price_per_unit.setValue(t.form.controls.price_per_unit.value||o.sales_rate)})}}},{type:"input",key:"quantity",templateOptions:{type:"number",label:"Qty",placeholder:"Enter Qty",min:1,hideLabel:!0,required:!0},hooks:{onInit:t=>{t.formControl.valueChanges.subscribe(o=>{if(t.form&&t.form.controls&&t.form.controls.price_per_unit&&o){const i=t.form.controls.price_per_unit.value;console.log("per unit price : ",i);const n=o;console.log("quantity : ",n),i&&n&&t.form.controls.total_price.setValue(i*n)}})},onChanges:t=>{}}},{type:"input",key:"price_per_unit",templateOptions:{type:"number",label:"Rate",placeholder:"Enter Rate",hideLabel:!0},hooks:{onInit:t=>{t.formControl.valueChanges.subscribe(o=>{if(t.form&&t.form.controls&&t.form.controls.quantity&&o){const i=t.form.controls.quantity.value;o&&i&&t.form.controls.total_price.setValue(parseInt(o)*parseInt(i))}})}}},{key:"total_price",type:"input",templateOptions:{type:"number",label:"Amount",placeholder:"Enter Amount",hideLabel:!0,disabled:!0}}]}}]}}calculateTotalPrice(){return this.formConfig.model.sale_debit_note_items.reduce((t,o)=>t+(o.total_price||0),0)}showDialog(){const t=document.getElementById("customDialog");t&&(t.style.display="flex")}closeDialog(){const t=document.getElementById("customDialog");t&&(t.style.display="none")}handleSubmission(){const t=this.calculateTotalPrice();(this.formConfig.model.sale_debit_note.total_amount||0)!==t?this.showDialog():this.createRecord()}createRecord(){const t={sale_debit_note:this.formConfig.model.sale_debit_note,sale_debit_note_items:this.formConfig.model.sale_debit_note_items.map(o=>({quantity:o.quantity,price_per_unit:o.price_per_unit,total_price:o.total_price,product_id:o.product?.product_id}))};this.http.post("sales/sale_debit_notes/",t).subscribe({next:o=>{this.showSuccessToast=!0,this.toastMessage="Record Created successfully",this.ngOnInit(),setTimeout(()=>{this.showSuccessToast=!1},3e3)},error:o=>{console.error("Error creating record:",o),alert("An error occurred while creating the record.")}})}loadSaleInvoices(t){this.http.get(`sales/sale_invoice_order/?customer_id=${t}`).subscribe(o=>{if(o&&Array.isArray(o.data)){this.invoiceOptions=o.data.map(n=>({value:n.sale_invoice_id,label:n.invoice_no}));const i=this.formConfig.fields.flatMap(n=>n.fieldGroup||[]).find(n=>"sale_invoice_id"===n.key);console.log("Invoice Field: ",i),i?(i.templateOptions.options=this.invoiceOptions,this.cdr.detectChanges()):console.error("Sale invoice field not found")}else console.error("Unexpected response structure or empty data")})}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(b.eN),e.Y36(e.sBO))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-debit-note"]],viewQuery:function(t,o){if(1&t&&(e.Gf(f,5),e.Gf(m,5)),2&t){let i;e.iGM(i=e.CRH())&&(o.salesdebitnoteForm=i.first),e.iGM(i=e.CRH())&&(o.DebitNoteListComponent=i.first)}},standalone:!0,features:[e.jDz],decls:30,vars:6,consts:[[1,"container-fluid","p-3"],[1,"sale-debit-banner"],[1,"col-12","px-0",2,"display","flex","justify-content","space-between","align-items","center","flex-wrap","wrap"],["type","button",1,"btn","pl-0"],["class","custom-heading",4,"ngIf"],[2,"display","flex","gap","10px","align-items","center","justify-content","end","flex-wrap","wrap"],["type","button","data-bs-toggle","modal","data-bs-target","#exampleModal",1,"btn","btn-primary",3,"click"],[1,"row","custom-form"],["class","col-12 px-1",4,"ngIf"],["id","exampleModal","tabindex","-1","aria-labelledby","exampleModalLabel","aria-hidden","true",1,"modal","fade","custom-modal"],[1,"modal-dialog","modal-xl"],[1,"modal-content"],[1,"modal-header"],["id","exampleModalLabel",1,"modal-title"],["type","button","id","modalClose","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],["class","modal-body",4,"ngIf"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-danger"],["class","sidebar-message",4,"ngIf"],["id","customDialog",1,"custom-dialog-overlay",2,"display","none"],[1,"custom-dialog-box"],["id","dialogOkButton",3,"click"],["id","customToast","class","toast-message",4,"ngIf"],[1,"custom-heading"],[1,"col-12","px-1"],[3,"options"],["salesdebitnoteForm",""],[1,"modal-body"],[1,"custom-list",3,"edit","circle"],[1,"sidebar-message"],[1,"checkmark-circle"],["id","customToast",1,"toast-message"],[1,"tick-circle"],[1,"tick-mark"],[1,"toast-message-text"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0)(1,"div",1)(2,"div",2)(3,"button",3),e.YNc(4,g,2,0,"span",4),e.YNc(5,h,2,0,"span",4),e.qZA(),e.TgZ(6,"div",5)(7,"button",6),e.NdJ("click",function(){return o.showSaleDebitNoteListFn()}),e._uU(8," Debit Note List "),e.qZA()()()(),e.TgZ(9,"div",7),e.YNc(10,y,3,1,"div",8),e.qZA()(),e.TgZ(11,"div",9)(12,"div",10)(13,"div",11)(14,"div",12)(15,"h5",13),e._uU(16,"Sale Debit Note List"),e.qZA(),e._UZ(17,"button",14),e.qZA(),e.YNc(18,C,2,0,"div",15),e.TgZ(19,"div",16)(20,"button",17),e._uU(21,"Close"),e.qZA()()()()(),e.YNc(22,x,4,1,"div",18),e.TgZ(23,"div",19)(24,"div",20)(25,"p"),e._uU(26," \u26a0\ufe0f The total price does not matching with total amount"),e.qZA(),e.TgZ(27,"button",21),e.NdJ("click",function(){return o.closeDialog()}),e._uU(28,"OK"),e.qZA()()(),e.YNc(29,v,6,1,"div",22)),2&t&&(e.xp6(4),e.Q6J("ngIf",o.SaleDebitnoteEditID),e.xp6(1),e.Q6J("ngIf",!o.SaleDebitnoteEditID),e.xp6(5),e.Q6J("ngIf",o.orderNumber),e.xp6(8),e.Q6J("ngIf",o.showSaleDebitnoteList),e.xp6(4),e.Q6J("ngIf",o.sidebarMessage),e.xp6(7),e.Q6J("ngIf",o.showSuccessToast))},dependencies:[l.ez,l.O5,d.l,_.C,m],styles:[".sidebar-message[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;background-color:#fff;color:#000;padding:10px 20px;border-radius:5px;box-shadow:0 2px 5px #0003;display:flex;align-items:center;z-index:1000;font-size:16px}.checkmark-circle[_ngcontent-%COMP%]{width:30px;height:30px;background-color:#fff;border:2px solid #008044;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px}.custom-dialog-overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:999}.custom-dialog-box[_ngcontent-%COMP%]{background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 8px #0003;text-align:center;width:300px}.custom-dialog-box[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:20px}.custom-dialog-box[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:10px 20px;background-color:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}.custom-dialog-box[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background-color:#0056b3}.toast-message[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;background-color:#fff;color:#000;padding:10px 20px;border-radius:5px;box-shadow:0 2px 5px #0003;display:flex;align-items:center;z-index:1000;font-size:16px}.tick-circle[_ngcontent-%COMP%]{width:30px;height:30px;background-color:#fff;border:2px solid #008044;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px}.tick-mark[_ngcontent-%COMP%]{color:#00804f;font-size:20px}"]}),s})()}}]);