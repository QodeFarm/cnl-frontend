"use strict";(self.webpackChunkcnl=self.webpackChunkcnl||[]).push([[977],{6977:($,g,i)=>{i.r(g),i.d(g,{SaleReceiptComponent:()=>E});var b=i(5861),u=i(6814),P=i(3929),t=i(5879),O=i(9862),v=i(5581);function S(a,l){if(1&a&&(t.TgZ(0,"div",6),t._uU(1),t.qZA()),2&a){const e=l.$implicit;t.xp6(1),t.AsE(" ",e.product_name," (Qty: ",e.quantity,") ")}}function M(a,l){if(1&a&&(t.ynx(0),t.YNc(1,S,2,2,"div",5),t.BQk()),2&a){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngForOf",e.products)}}function I(a,l){1&a&&t._uU(0,"No products available")}function U(a,l){if(1&a&&(t.YNc(0,M,2,1,"ng-container",3),t.YNc(1,I,1,0,"ng-template",null,4,t.W1O)),2&a){const e=l.$implicit,o=t.MAs(2);t.Q6J("ngIf",e.products&&e.products.length>0)("ngIfElse",o)}}function x(a,l){if(1&a){const e=t.EpF();t.TgZ(0,"div",7)(1,"div",8)(2,"h5"),t._uU(3,"Confirm Receipt"),t.qZA(),t.TgZ(4,"p"),t._uU(5),t.qZA(),t.TgZ(6,"div",9)(7,"button",10),t.NdJ("click",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.closeModal())}),t._uU(8,"Cancel"),t.qZA(),t.TgZ(9,"button",11),t.NdJ("click",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.confirmReceipt())}),t._uU(10,"Confirm"),t.qZA()()()()}if(2&a){const e=t.oxw();t.xp6(5),t.hij("Are you sure you want to confirm the receipt for order ",null==e.selectedReceipt?null:e.selectedReceipt.receipt_no,"?")}}let E=(()=>{class a{constructor(e){this.http=e,this.isLoading=!0,this.showModal=!1,this.selectedOrder=null,this.curdConfig=this.getCurdConfig()}ngOnInit(){this.isLoading=!1}getCurdConfig(){return{drawerSize:500,drawerPlacement:"right",hideAddBtn:!0,tableConfig:{apiUrl:"sales/sale_order/?summary=true&flow_status=Delivery In progress",title:"Sales Receipt",pkId:"sale_order_id",pageSize:10,globalSearch:{keys:["customer","order_no","invoice_no","products"]},defaultSort:{key:"created_at",value:"descend"},cols:[{fieldKey:"customer",name:"Customer",displayType:"map",mapFn:(e,o)=>`${o.customer.name}`,sort:!0},{fieldKey:"order_no",name:"Order No",sort:!0},{fieldKey:"invoice_no",name:"Invoice No"},{fieldKey:"products",name:"Products",displayType:"map",mapFn:(e,o)=>o.products&&"object"==typeof o.products?Object.values(o.products).map(r=>`${r.product_name} (Qty: ${r.quantity})`).join(", "):"No products"},{fieldKey:"file_upload",name:"Upload File",displayType:"file",actions:[{type:"callBackFn",label:"Upload",callBackFn:e=>this.uploadFile(e)}]},{fieldKey:"actions",name:"Actions",type:"action",actions:[{type:"callBackFn",label:"Confirm Receipt",callBackFn:e=>this.openModal(e)}]}]},formConfig:{url:"sales/SaleOrder/{saleOrderId}/move_to_next/",title:"Sales Receipt Confirmation",pkId:"sale_order_id",exParams:[],fields:[{key:"sale_order_id",type:"text"},{key:"confirmation",type:"select",defaultValue:"yes"}]}}}openModal(e){this.selectedOrder=e,this.showModal=!0}closeModal(){this.showModal=!1,this.selectedOrder=null}refreshCurdConfig(){this.curdConfig=this.getCurdConfig()}uploadFile(e){const o=document.createElement("input");o.type="file",o.style.display="none",o.onchange=()=>{const r=o.files?o.files[0]:null;r&&(e.selectedFile=r,e.selectedFileName=r.name)},document.body.appendChild(o),o.click(),document.body.removeChild(o)}fetchSaleInvoiceId(e){return this.http.get(`sales/sale_invoice_order_get/?sale_order_id=${e}`).toPromise().then(r=>(console.log("hiiii",r.data[0].sale_invoice_id),r&&r.data[0].sale_invoice_id?(console.log("we are in method"),r.data[0].sale_invoice_id):(console.error("Sale invoice ID not found in response."),alert("Could not retrieve sale invoice ID."),null))).catch(r=>(console.error("Error fetching sale invoice ID:",r),alert("Failed to fetch sale invoice ID. Please try again."),null))}generateUID(){return Math.random().toString(36).substr(2,9)}prepareFileMetadata(e){const o=this.generateUID();return{uid:o,name:e.name,file_size:e.size,attachment_name:e.name,attachment_path:`${o}_${e.name}`}}confirmReceipt(){var e=this;return(0,b.Z)(function*(){if(e.selectedOrder){const o=e.selectedOrder.sale_order_id,r=e.selectedOrder.order_no.split("-").slice(0,3).join("-");console.log("Processing child sale order:",o),console.log("Parent Order No:",r);const h=yield e.fetchSaleInvoiceId(o);if(!h)return void console.error("Sale invoice ID is missing or couldn't be fetched.");const D="sales/sale_receipts/";let C=[];e.selectedOrder.selectedFile&&(C=[e.prepareFileMetadata(e.selectedOrder.selectedFile)]),e.http.post(D,{sale_invoice_id:h,receipt_name:`Receipt for Order ${o}`,description:"Uploaded receipt for order confirmation",receipt_path:C}).subscribe(d=>{console.log(" Sale receipt created successfully:",d),e.http.patch(`sales/sale_order/${o}/`,{flow_status_id:"595ae9ff-8806-4ca5-ba04-bcb572ee0194",order_status_id:"717c922f-c092-4d40-94e7-6a12d7095600"}).subscribe(()=>{console.log(` Child Sale Order ${o} updated to Completed.`),e.closeModal(),e.refreshCurdConfig();const _=`sales/sale_order/?parent_order_no=${r}`;console.log("Fetching child orders with URL:",_),e.http.get(_).subscribe(c=>{console.log(" Fetched child sale orders:",c),console.log(" Checking all child orders' statuses:"),c.data.forEach(n=>{console.log(`Order No: ${n.order_no}, Flow Status: ${n.flow_status.flow_status_name}`)});const y=c.data.filter(n=>n.order_no!==r).every(n=>"Completed"===n.flow_status.flow_status_name);if(console.log(" allCompleted:",y),y){console.log(` All child sale orders for ${r} are completed. Updating parent order.`);const n=c.data.find(s=>s.order_no===r);if(n){const s=n.sale_order_id;console.log(" Parent Sale Order ID:",s);const p=`sales/sale_order/${s}/`;console.log(" updateParentStatusUrl:",p),e.http.patch(p,{flow_status_id:"595ae9ff-8806-4ca5-ba04-bcb572ee0194",order_status_id:"717c922f-c092-4d40-94e7-6a12d7095600"}).subscribe(()=>{console.log(` Parent Sale Order ${r} updated to Completed.`),e.closeModal(),e.refreshCurdConfig()},m=>{console.error(" Error updating parent sale order status:",m),alert("Failed to update parent sale order status. Please try again.")})}else console.error(` Parent Sale Order ${r} not found.`)}else{console.log('Some child sale orders are still pending. Updating parent order to "Partially Delivered".');const n=c.data.find(s=>s.order_no===r);if(n){const s=n.sale_order_id;console.log(" Parent Sale Order ID:",s);const p=`sales/sale_order/${s}/`;console.log(" updateParentStatusUrl:",p),e.http.patch(p,{flow_status_id:"35ba9d92-dd2b-4adf-94ec-1391e50cfb30",order_status_id:"e2079d63-2e5f-4f8e-9d8b-817cefa87398"}).subscribe(()=>{console.log(` Parent Sale Order ${r} updated to Partially Delivered.`),e.closeModal(),e.refreshCurdConfig()},m=>{console.error(" Error updating parent sale order status:",m),alert("Failed to update parent sale order status. Please try again.")})}else console.error(` Parent Sale Order ${r} not found.`)}},c=>{console.error(" Error fetching child sale orders:",c),alert("Failed to fetch child sale orders. Please try again.")})},_=>{console.error(" Error updating child sale order status:",_),alert("Failed to update child sale order status. Please try again.")})},d=>{console.error(" Error in creating sale receipt:",d),alert("Failed to create sale receipt. Please try again.")})}else console.warn(" No order selected for confirmation.")})()}}return a.\u0275fac=function(e){return new(e||a)(t.Y36(O.eN))},a.\u0275cmp=t.Xpm({type:a,selectors:[["app-sale-receipt"]],standalone:!0,features:[t.jDz],decls:4,vars:3,consts:[[1,"custom-list","sale-receipt-table",3,"options","customProductTemplate"],["customProductTemplate",""],["class","custom-dialog-overlay",4,"ngIf"],[4,"ngIf","ngIfElse"],["noProducts",""],["style","display: flex; align-items: center;",4,"ngFor","ngForOf"],[2,"display","flex","align-items","center"],[1,"custom-dialog-overlay"],[1,"custom-dialog-box"],[1,"dialog-actions"],[1,"btn","btn-danger",3,"click"],[1,"btn","btn-primary",3,"click"]],template:function(e,o){if(1&e&&(t._UZ(0,"ta-curd-modal",0),t.YNc(1,U,3,2,"ng-template",null,1,t.W1O),t.YNc(3,x,11,1,"div",2)),2&e){const r=t.MAs(2);t.Q6J("options",o.curdConfig)("customProductTemplate",r),t.xp6(3),t.Q6J("ngIf",o.showModal)}},dependencies:[u.ez,u.sg,u.O5,P.l,v.h],styles:[".dialog-actions[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:10px;margin-top:15px}.dialog-actions[_ngcontent-%COMP%]   .btn-danger[_ngcontent-%COMP%]{border:1px solid #e74a3b;background-color:#e74a3b;color:#fff}.dialog-actions[_ngcontent-%COMP%]   .btn-danger[_ngcontent-%COMP%]:hover{border:1px solid #e02d1b;background-color:#e02d1b;color:#fff}.dialog-actions[_ngcontent-%COMP%]   .btn-primary[_ngcontent-%COMP%]{border:1px solid #142768;background-color:#142768;color:#fff}.dialog-actions[_ngcontent-%COMP%]   .btn-primary[_ngcontent-%COMP%]:hover{border:1px solid #233a88;background-color:#233a88;color:#fff}button[_ngcontent-%COMP%]{min-width:80px;padding:8px 16px;font-size:14px}"]}),a})()}}]);