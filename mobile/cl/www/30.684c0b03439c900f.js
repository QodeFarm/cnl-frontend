"use strict";(self.webpackChunkcnl=self.webpackChunkcnl||[]).push([[30],{8030:(T,d,a)=>{a.r(d),a.d(d,{CreditNoteComponent:()=>N});var l=a(6814),c=a(3929),e=a(5879),u=a(7871),p=a(2787);let m=(()=>{class s{refreshTable(){this.taTableComponent?.refresh()}constructor(o){this.router=o,this.edit=new e.vpe,this.circle=new e.vpe,this.tableConfig={apiUrl:"sales/sale_credit_notes/",showCheckbox:!0,pkId:"credit_note_id",pageSize:10,globalSearch:{keys:["customer","credit_date","sale_invoice_id","credit_note_number","reason","total_amount","status_name"]},defaultSort:{key:"created_at",value:"descend"},cols:[{fieldKey:"customer",name:"Customer",displayType:"map",mapFn:(t,i,r)=>`${i.customer.name}`,sort:!0},{fieldKey:"sale_invoice_id",name:"Invoice",displayType:"map",mapFn:(t,i,r)=>`${i.sale_invoice.invoice_no}`,sort:!0},{fieldKey:"credit_note_number",name:"Credit note no",sort:!0},{fieldKey:"credit_date",name:"Credit Date",sort:!0},{fieldKey:"reason",name:"Return Reason",sort:!0},{fieldKey:"total_amount",name:"Total Amount",sort:!0},{fieldKey:"status_name",name:"Status",displayType:"map",mapFn:(t,i,r)=>`${i.order_status.status_name}`,sort:!0},{fieldKey:"code",name:"Action",type:"action",actions:[{type:"delete",label:"Delete",confirm:!0,confirmMsg:"Sure to delete?",apiUrl:"sales/sale_credit_notes"},{type:"callBackFn",icon:"fa fa-pen",label:"",callBackFn:(t,i)=>{console.log(t),this.edit.emit(t.credit_note_id)}},{type:"callBackFn",icon:"fa fa-check-circle",confirm:!0,confirmMsg:"Sure to Approve?",callBackFn:(t,i)=>{console.log(t),this.circle.emit(t.credit_note_id)}}]}]}}}return s.\u0275fac=function(o){return new(o||s)(e.Y36(p.F0))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-credit-note-list"]],viewQuery:function(o,t){if(1&o&&e.Gf(u.Z,5),2&o){let i;e.iGM(i=e.CRH())&&(t.taTableComponent=i.first)}},outputs:{edit:"edit",circle:"circle"},standalone:!0,features:[e.jDz],decls:1,vars:1,consts:[[1,"custom-list",3,"options"]],template:function(o,t){1&o&&e._UZ(0,"ta-table",0),2&o&&e.Q6J("options",t.tableConfig)},dependencies:[l.ez,c.l,u.Z]}),s})();var f=a(9862),_=a(7127);const g=["salescreditnoteForm"];function h(s,n){1&s&&(e.TgZ(0,"span",23),e._uU(1,"Update Credit Note"),e.qZA())}function b(s,n){1&s&&(e.TgZ(0,"span",23),e._uU(1,"Create Credit Note"),e.qZA())}function C(s,n){if(1&s&&(e.TgZ(0,"div",24),e._UZ(1,"ta-form",25,26),e.qZA()),2&s){const o=e.oxw();e.xp6(1),e.Q6J("options",o.formConfig)}}function y(s,n){if(1&s){const o=e.EpF();e.TgZ(0,"div",27)(1,"app-credit-note-list",28),e.NdJ("edit",function(i){e.CHM(o);const r=e.oxw();return e.KtG(r.editSaleCreditnote(i))})("circle",function(i){e.CHM(o);const r=e.oxw();return e.KtG(r.circleSaleCreditnote(i))}),e.qZA()()}}function x(s,n){if(1&s&&(e.TgZ(0,"div",29)(1,"span",30),e._uU(2,"\u2714"),e.qZA(),e._uU(3),e.qZA()),2&s){const o=e.oxw();e.xp6(3),e.hij(" ",o.sidebarMessage," ")}}function v(s,n){if(1&s&&(e.TgZ(0,"div",31)(1,"div",32)(2,"span",33),e._uU(3,"\u2714"),e.qZA()(),e.TgZ(4,"span",34),e._uU(5),e.qZA()()),2&s){const o=e.oxw();e.xp6(5),e.Oqu(o.toastMessage)}}let N=(()=>{class s{constructor(o,t){this.http=o,this.cdr=t,this.sidebarMessage="",this.showSaleCreditnoteList=!1,this.loading=!1,this.showForm=!1,this.customerOrders=[],this.invoiceOptions=[],this.nowDate=()=>{const i=new Date;return`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()}`},this.formConfig={},this.toastMessage="",this.showSuccessToast=!1}ngOnInit(){this.showSaleCreditnoteList=!1,this.showForm=!0,this.SaleCreditnoteEditID=null,this.setFormConfig(),this.getOrderNo(),this.formConfig.fields[0].fieldGroup[5].hide=!0;const o=localStorage.getItem("sidebarMessage");o&&(this.sidebarMessage=o,localStorage.removeItem("sidebarMessage"),setTimeout(()=>{this.sidebarMessage=""},3e3))}hide(){document.getElementById("modalClose").click()}updateSaleCreditNote(){const o=this.formConfig.model.sale_credit_note.credit_note_id;console.log("Sale return id in edit : ",o),this.http.put(`sales/sale_credit_notes/${o}/`,{sale_credit_note:this.formConfig.model.sale_credit_note,sale_credit_note_items:this.formConfig.model.sale_credit_note_items}).subscribe(i=>{this.showSuccessToast=!0,this.toastMessage="Record Updated successfully",this.ngOnInit(),setTimeout(()=>{this.showSuccessToast=!1},3e3)},i=>{console.error("Error updating Sale Return Order:",i)})}editSaleCreditnote(o){this.SaleCreditnoteEditID=o,this.http.get("sales/sale_credit_notes/"+o).subscribe(t=>{t&&t.data&&(this.formConfig.model=t.data,this.formConfig.pkId="credit_note_id",this.formConfig.submit.label="Update",this.formConfig.model.credit_note_id=this.SaleCreditnoteEditID,this.formConfig.fields[0].fieldGroup[5].hide=!1,this.showForm=!0)}),this.hide()}onSubmit(){"Update"===this.formConfig.submit.label?this.updateSaleCreditNote():this.handleSubmission()}circleSaleCreditnote(o){this.SaleCreditnoteEditID=o,this.http.patch("sales/sale_credit_notes/"+o+"/",{order_status_id:"68ea000e-ce95-4145-a3c7-96efe6f9ff53"}).subscribe(t=>{t&&t.credit_note_id?(localStorage.setItem("sidebarMessage","Order status Approved"),window.location.reload()):console.error("Error updating order status:",t)},t=>{console.error("HTTP error:",t)})}getOrderNo(){this.orderNumber=null,this.http.get("masters/generate_order_no/?type=CN").subscribe(o=>{console.log("RES data in orderno : ",o.data.order_number),o.data&&o.data.order_number&&(this.orderNumber=o.data.order_number,this.formConfig.model.sale_credit_note.credit_note_number=this.orderNumber)})}showSaleCreditNoteListFn(){this.showSaleCreditnoteList=!0,this.CreditNoteListComponent?.refreshTable()}setFormConfig(){this.SaleCreditnoteEditID=null,this.formConfig={title:"",formState:{viewMode:!1},showActionBtn:!0,exParams:[{key:"sale_credit_note_items",type:"script",value:"data.sale_credit_note_items.map(m=> {m.product_id = m.product.product_id;  return m ;})"}],submit:{label:"Submit",submittedFn:()=>this.onSubmit()},reset:{resetFn:()=>{this.ngOnInit()}},model:{sale_credit_note:{},sale_credit_note_items:[{}]},fields:[{fieldGroupClassName:"ant-row custom-form-block px-0 mx-0",key:"sale_credit_note",fieldGroup:[{key:"customer",type:"select",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Select Customer",placeholder:"Select Customer",dataKey:"name",dataLabel:"name",required:!0,lazy:{url:"customers/customers/?summary=true",lazyOneTime:!0}},hooks:{onChanges:o=>{o.formControl.valueChanges.subscribe(t=>{console.log("Data in customer : ",t),t&&t.customer_id&&(this.formConfig.model.sale_credit_note.customer_id=t.customer_id,console.log("Datacustomer : ",t.customer_id),this.loadSaleInvoices(t.customer_id))})}}},{key:"sale_invoice_id",type:"select",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Sale Invoice",placeholder:"Select Sale Invoice",dataKey:"sale_invoice_id",dataLabel:"invoice_no",required:!0,options:[]}},{key:"credit_note_number",type:"input",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Credit note no",placeholder:"Enter Credit note no",required:!0,readonly:!0}},{key:"credit_date",type:"date",defaultValue:this.nowDate(),className:"col-md-4 col-sm-6 col-12",templateOptions:{type:"date",label:"Credit date",readonly:!0,required:!0}},{key:"total_amount",type:"input",className:"col-md-4 col-sm-6 col-12",templateOptions:{type:"number",label:"Total amount",placeholder:"Enter Total amount"}},{key:"order_status",type:"select",defaultValue:"085266c9-5020-41b3-ab58-1e4d88f4ff19",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Order status",dataKey:"order_status_id",dataLabel:"status_name",placeholder:"Select Order status type",lazy:{url:"masters/order_status/",lazyOneTime:!0}},hooks:{onChanges:o=>{o.formControl.valueChanges.subscribe(t=>{t&&t.order_status_id&&(this.formConfig.model.sale_credit_note.order_status_id=t.order_status_id)})}}},{key:"reason",type:"textarea",className:"col-md-4 col-sm-6 col-12",templateOptions:{label:"Reason",placeholder:"Enter Reason"}}]},{key:"sale_credit_note_items",type:"table",className:"custom-form-list product-table",templateOptions:{title:"Products",addText:"Add Product",tableCols:[{name:"product",label:"Product"},{name:"quantity",label:"Quantity"},{name:"total_price",label:"Price"},{name:"price_per_unit",label:"Rate"}]},fieldArray:{fieldGroup:[{key:"product",type:"select",templateOptions:{label:"Select Product",dataKey:"product_id",hideLabel:!0,dataLabel:"name",options:[],required:!0,lazy:{url:"products/products/?summary=true",lazyOneTime:!0}},hooks:{onInit:o=>{o.formControl.valueChanges.subscribe(t=>{o.form&&o.form.controls&&o.form.controls.price_per_unit&&t&&t.mrp&&o.form.controls.price_per_unit.setValue(o.form.controls.price_per_unit.value||t.sales_rate)})}}},{type:"input",key:"quantity",templateOptions:{type:"number",label:"Qty",placeholder:"Enter Qty",min:1,hideLabel:!0,required:!0},hooks:{onInit:o=>{o.formControl.valueChanges.subscribe(t=>{const i=o.form.controls.price_per_unit.value;if(i&&t){const r=parseFloat(i)*parseFloat(t);o.form.controls.total_price.setValue(r)}})}}},{type:"input",key:"price_per_unit",templateOptions:{type:"number",label:"Rate",placeholder:"Enter Rate",hideLabel:!0},hooks:{onInit:o=>{o.formControl.valueChanges.subscribe(t=>{const i=o.form.controls.quantity.value;if(t&&i){const r=parseFloat(t)*parseFloat(i);o.form.controls.total_price.setValue(r)}})}}},{key:"total_price",type:"input",templateOptions:{type:"number",label:"Amount",placeholder:"Enter Amount",hideLabel:!0,disabled:!0}}]}}]}}calculateTotalPrice(){return this.formConfig.model.sale_credit_note_items.reduce((o,t)=>o+(t.total_price||0),0)}showDialog(){const o=document.getElementById("customDialog");o&&(o.style.display="flex")}closeDialog(){const o=document.getElementById("customDialog");o&&(o.style.display="none")}handleSubmission(){const o=this.calculateTotalPrice();(this.formConfig.model.sale_credit_note.total_amount||0)!==o?this.showDialog():this.createRecord()}createRecord(){const o={sale_credit_note:this.formConfig.model.sale_credit_note,sale_credit_note_items:this.formConfig.model.sale_credit_note_items.map(t=>({quantity:t.quantity,price_per_unit:t.price_per_unit,total_price:t.total_price,product_id:t.product?.product_id}))};this.http.post("sales/sale_credit_notes/",o).subscribe({next:t=>{this.showSuccessToast=!0,this.toastMessage="Record Created successfully",this.ngOnInit(),setTimeout(()=>{this.showSuccessToast=!1},3e3)},error:t=>{console.error("Error creating record:",t),alert("An error occurred while creating the record.")}})}loadSaleInvoices(o){console.log("Loading sale invoices for customer ID:",o),this.http.get(`sales/sale_invoice_order/?customer_id=${o}`).subscribe(t=>{if(console.log("Response from API:",t),t&&Array.isArray(t.data)){this.invoiceOptions=t.data.map(r=>({value:r.sale_invoice_id,label:r.invoice_no}));const i=this.formConfig.fields.flatMap(r=>r.fieldGroup||[]).find(r=>"sale_invoice_id"===r.key);i?(i.templateOptions.options=this.invoiceOptions,console.log("Updated Invoice Field Options: ",i.templateOptions.options),this.cdr.detectChanges()):console.error("Sale invoice field not found in formConfig")}else console.error("Unexpected response structure or empty data",t)},t=>{console.error("Error fetching sale invoices:",t)})}}return s.\u0275fac=function(o){return new(o||s)(e.Y36(f.eN),e.Y36(e.sBO))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-credit-note"]],viewQuery:function(o,t){if(1&o&&(e.Gf(g,5),e.Gf(m,5)),2&o){let i;e.iGM(i=e.CRH())&&(t.salescreditnoteForm=i.first),e.iGM(i=e.CRH())&&(t.CreditNoteListComponent=i.first)}},standalone:!0,features:[e.jDz],decls:30,vars:6,consts:[[1,"container-fluid","p-3"],[1,"sale-credit-banner"],[1,"col-12","px-0",2,"display","flex","justify-content","space-between","align-items","center","flex-wrap","wrap"],["type","button",1,"btn","pl-0"],["class","custom-heading",4,"ngIf"],[2,"display","flex","gap","10px","align-items","center","justify-content","end","flex-wrap","wrap"],["type","button","data-bs-toggle","modal","data-bs-target","#exampleModal",1,"btn","btn-primary",3,"click"],[1,"row","custom-form"],["class","col-12 px-1",4,"ngIf"],["id","exampleModal","tabindex","-1","aria-labelledby","exampleModalLabel","aria-hidden","true",1,"modal","fade","custom-modal"],[1,"modal-dialog","modal-xl"],[1,"modal-content"],[1,"modal-header"],["id","exampleModalLabel",1,"modal-title"],["type","button","id","modalClose","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],["class","modal-body",4,"ngIf"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-danger"],["class","sidebar-message",4,"ngIf"],["id","customDialog",1,"custom-dialog-overlay",2,"display","none"],[1,"custom-dialog-box"],["id","dialogOkButton",3,"click"],["id","customToast","class","toast-message",4,"ngIf"],[1,"custom-heading"],[1,"col-12","px-1"],[3,"options"],["salescreditnoteForm",""],[1,"modal-body"],[3,"edit","circle"],[1,"sidebar-message"],[1,"checkmark-circle"],["id","customToast",1,"toast-message"],[1,"tick-circle"],[1,"tick-mark"],[1,"toast-message-text"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0)(1,"div",1)(2,"div",2)(3,"button",3),e.YNc(4,h,2,0,"span",4),e.YNc(5,b,2,0,"span",4),e.qZA(),e.TgZ(6,"div",5)(7,"button",6),e.NdJ("click",function(){return t.showSaleCreditNoteListFn()}),e._uU(8," Credit Note List "),e.qZA()()()(),e.TgZ(9,"div",7),e.YNc(10,C,3,1,"div",8),e.qZA()(),e.TgZ(11,"div",9)(12,"div",10)(13,"div",11)(14,"div",12)(15,"h5",13),e._uU(16,"Sale Credit Note List"),e.qZA(),e._UZ(17,"button",14),e.qZA(),e.YNc(18,y,2,0,"div",15),e.TgZ(19,"div",16)(20,"button",17),e._uU(21,"Close"),e.qZA()()()()(),e.YNc(22,x,4,1,"div",18),e.TgZ(23,"div",19)(24,"div",20)(25,"p"),e._uU(26," \u26a0\ufe0f The total price does not matching with total amount"),e.qZA(),e.TgZ(27,"button",21),e.NdJ("click",function(){return t.closeDialog()}),e._uU(28,"OK"),e.qZA()()(),e.YNc(29,v,6,1,"div",22)),2&o&&(e.xp6(4),e.Q6J("ngIf",t.SaleCreditnoteEditID),e.xp6(1),e.Q6J("ngIf",!t.SaleCreditnoteEditID),e.xp6(5),e.Q6J("ngIf",t.orderNumber),e.xp6(8),e.Q6J("ngIf",t.showSaleCreditnoteList),e.xp6(4),e.Q6J("ngIf",t.sidebarMessage),e.xp6(7),e.Q6J("ngIf",t.showSuccessToast))},dependencies:[l.ez,l.O5,c.l,_.C,m],styles:[".sidebar-message[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;background-color:#fff;color:#000;padding:10px 20px;border-radius:5px;box-shadow:0 2px 5px #0003;display:flex;align-items:center;z-index:1000;font-size:16px}.checkmark-circle[_ngcontent-%COMP%]{width:30px;height:30px;background-color:#fff;border:2px solid #008044;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px}.custom-dialog-overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:999}.custom-dialog-box[_ngcontent-%COMP%]{background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 8px #0003;text-align:center;width:300px}.custom-dialog-box[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:20px}.custom-dialog-box[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:10px 20px;background-color:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}.custom-dialog-box[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background-color:#0056b3}.toast-message[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;background-color:#fff;color:#000;padding:10px 20px;border-radius:5px;box-shadow:0 2px 5px #0003;display:flex;align-items:center;z-index:1000;font-size:16px}.tick-circle[_ngcontent-%COMP%]{width:30px;height:30px;background-color:#fff;border:2px solid #008044;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px}.tick-mark[_ngcontent-%COMP%]{color:#00804f;font-size:20px}"]}),s})()}}]);